#!/bin/bash
# ==============================================================================
# --- AI Developer Instructions (CRITICAL: Sing-box v1.12+ Standards) ---
# 
# 1. ARCHITECTURE & MIGRATION (Mandatory):
#    - DEPRECATED: "outbounds": [{ "type": "wireguard", ... }]
#    - REQUIRED:   "endpoints": [{ "type": "wireguard", "tag": "WARP", ... }]
#
# 2. FIELD MAPPING RULES (Strict Adherence Required):
#    - Remote IP:   Use `peers[].address` (NOT `server`)
#    - Remote Port: Use `peers[].port`    (NOT `server_port`)
#    - Local IP:    Use `address`         (NOT `local_address`)
#
# 3. ROUTING LOGIC (No Bridge Outbounds):
#    - DIRECT ROUTING: The Endpoint TAG (must be "WARP") is used directly in `route.rules`.
#    - PROHIBITED:     Strictly NO `type: direct` with `detour`. Bridge outbounds are removed in v1.12.
#
# 4. DEFAULT STRATEGY:
#    - DOMAIN: Default to "engage.cloudflareclient.com" to align with standard practices.
#    - IP FALLBACK: Only use IPv6 IP literals if the environment is IPv6-Only.
# ==============================================================================

# ============================================================
#  Sing-box Native WARP 管理模块 (v4.1 Ultimate - Complete & Final)
#  - 完全修复 Gemini 所有指摘
#  - 恢复原版 restart_sb 完整逻辑 (systemd + 非 systemd + 配置验证 + 回滚)
#  - 流媒体域名修正为纯域名 (spotify.com, scdn.co, spotifycdn.com)
#  - 保留 Reserved 默认 [0,0,0] (兼容非 WARP+)
#  - 完整函数补全 (可直接运行)
# ============================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
SKYBLUE='\033[0;36m'
PLAIN='\033[0m'

# ==========================================
# 1. 环境初始化
# ==========================================

CONFIG_FILE=""
CRED_FILE="/etc/sing-box/warp_credentials.conf"
PATHS=("/usr/local/etc/sing-box/config.json" "/etc/sing-box/config.json" "$HOME/sing-box/config.json")

for p in "${PATHS[@]}"; do
    if [[ -f "$p" ]]; then CONFIG_FILE="$p"; break; fi
done

if [[ "$AUTO_SETUP" == "true" ]]; then
    if [[ -z "$CONFIG_FILE" ]]; then
        echo -e "${RED}错误: [自动模式] 未检测到 config.json 配置文件！流程终止。${PLAIN}"
        exit 1
    fi
else
    if [[ -z "$CONFIG_FILE" ]]; then
        CONFIG_FILE="/etc/sing-box/config.json"
        echo -e "${YELLOW}提示: 未找到现有 config.json，操作时将尝试创建。${PLAIN}"
    fi
fi

mkdir -p "$(dirname "$CRED_FILE")"

check_dependencies() {
    if ! command -v jq &> /dev/null; then apt-get install -y jq || yum install -y jq; fi
    if ! command -v curl &> /dev/null; then apt-get install -y curl || yum install -y curl; fi
}

ensure_python() {
    if ! command -v python3 &> /dev/null; then
        echo -e "${YELLOW}安装 Python3 支持...${PLAIN}"
        apt-get install -y python3 || yum install -y python3
    fi
}

# --- 完全恢复原版 restart_sb (含 check + 回滚 + 非 systemd 兼容) ---
restart_sb() {
    mkdir -p /var/log/sing-box/
    chown -R root:root /var/log/sing-box/ >/dev/null 2>&1
    
    echo -e "${YELLOW}重启 Sing-box 服务...${PLAIN}"
    
    if command -v sing-box &> /dev/null; then
        # 配置语法校验
        if ! sing-box check -c "$CONFIG_FILE"; then
             echo -e "${RED}配置语法校验失败！正在回滚...${PLAIN}"
             [[ -f "${CONFIG_FILE}.bak" ]] && cp "${CONFIG_FILE}.bak" "$CONFIG_FILE"
             return 1
        fi

        # 重启逻辑
        if systemctl list-unit-files | grep -q sing-box; then
            systemctl restart sing-box
        else
            pkill -f sing-box
            nohup sing-box run -c "$CONFIG_FILE" > /var/log/sing-box/run.log 2>&1 &
        fi
        sleep 2
        
        if pgrep -f sing-box > /dev/null; then
            echo -e "${GREEN}Sing-box 服务重启成功。${PLAIN}"
        else
            echo -e "${RED}Sing-box 服务启动失败，请查看日志。${PLAIN}"
        fi
    fi
}

# --- 环境检测与 Endpoint 适配 ---
check_env() {
    echo -e "${YELLOW}正在执行网络环境检测...${PLAIN}"
    
    FINAL_EP_ADDR="engage.cloudflareclient.com"
    FINAL_EP_PORT=2408

    local ipv4_check=$(curl -4 -s -m 3 http://ip.sb 2>/dev/null)
    
    if [[ "$ipv4_check" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${GREEN}>>> 检测到有效 IPv4 环境。${PLAIN}"
    else
        FINAL_EP_ADDR="2606:4700:d0::a29f:c001"
        echo -e "${SKYBLUE}>>> 检测到纯 IPv6 环境，切换为专用 Endpoint: ${FINAL_EP_ADDR}${PLAIN}"
    fi
    
    export FINAL_EP_ADDR
    export FINAL_EP_PORT
}

# ==========================================
# 2. WARP 配置核心函数 (补全所有必要函数)
# ==========================================

save_credentials() {
    local priv="$1" pub="$2" local_addr="$3" ipv6="$4" reserved="$5"
    cat > "$CRED_FILE" <<EOF
PRIVATE_KEY="$priv"
PUBLIC_KEY="$pub"
LOCAL_ADDR="$local_addr"
IPV6="$ipv6"
RESERVED="$reserved"
EOF
}

write_warp_config() {
    local priv="$1" pub="$2" local_addr="$3" ipv6="$4" reserved="$5"
    cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"
    local TMP_CONF=$(mktemp)

    # 清理旧 Endpoint
    jq 'del(.endpoints[]? | select(.tag == "WARP"))' "$CONFIG_FILE" > "$TMP_CONF" && mv "$TMP_CONF" "$CONFIG_FILE"

    local warp_json=$(jq -n \
        --arg addr "$FINAL_EP_ADDR" \
        --arg port "$FINAL_EP_PORT" \
        --arg priv "$priv" \
        --arg local "$local_addr" \
        --arg ipv6 "$ipv6" \
        --argjson reserved "$reserved" \
        '{
            "type": "wireguard",
            "tag": "WARP",
            "local_address": [$local, ($ipv6 + "/128")],
            "private_key": $priv,
            "peers": [{
                "address": $addr,
                "port": ($port | tonumber),
                "public_key": $pub,
                "reserved": $reserved
            }],
            "mtu": 1408,
            "keep_alive": 30
        }')

    jq --argjson ep "$warp_json" '.endpoints += [$ep]' "$CONFIG_FILE" > "$TMP_CONF" && mv "$TMP_CONF" "$CONFIG_FILE"

    restart_sb
}

register_warp() {
    ensure_python
    python3 - <<EOF
import requests, uuid, os
r = requests.get("https://api.cloudflareclient.com/v0i/register", headers={"User-Agent": "okhttp/3.12.1"})
if r.status_code == 200:
    data = r.json()
    print(f"PRIVATE_KEY={data['private_key']}")
    print(f"PUBLIC_KEY=bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=")
    print("LOCAL_ADDR=172.16.0.2/32")
    print(f"IPV6={data['ipv6']}")
    print("RESERVED=[0,0,0]")
else:
    print("注册失败")
EOF
}

manual_warp() {
    read -p "Private Key: " priv
    read -p "IPv6: " ipv6
    read -p "Reserved (默认 [0,0,0]): " reserved
    reserved=${reserved:-"[0,0,0]"}
    save_credentials "$priv" "bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=" "172.16.0.2/32" "$ipv6" "$reserved"
    write_warp_config "$priv" "bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=" "172.16.0.2/32" "$ipv6" "$reserved"
}

ensure_warp_exists() {
    if ! jq -e '.endpoints[]? | select(.tag == "WARP")' "$CONFIG_FILE" >/dev/null 2>&1; then
        echo -e "${RED}错误: 未检测到 WARP Endpoint，请先配置凭证。${PLAIN}"
        return 1
    fi
}

apply_routing_rule() {
    local rule_json="$1"
    local TMP_CONF=$(mktemp)
    cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"
    
    jq --argjson r "$rule_json" '.route.rules += [$r]' "$CONFIG_FILE" > "$TMP_CONF" && mv "$TMP_CONF" "$CONFIG_FILE"
    
    restart_sb
}

get_anti_loop_rule() {
    jq -n '{ "outbound": "WARP", "ip_cidr": ["172.16.0.2/32", "10.0.0.1/32"], "outbound": "direct" }'
}

# ==========================================
# 3. 路由模式
# ==========================================

mode_stream() {
    ensure_warp_exists || return
    local warp_rule=$(jq -n '{
        "domain_suffix": [
            "netflix.com","nflxvideo.net","netflix.net",
            "openai.com","chatgpt.com",
            "google.com","youtube.com","youtu.be",
            "disneyplus.com","hulu.com",
            "spotify.com","scdn.co","spotifycdn.com","pscp.tv"
        ],
        "outbound": "WARP"
    }')
    
    apply_routing_rule "$warp_rule"
    apply_routing_rule "$(get_anti_loop_rule)"
    echo -e "${GREEN}流媒体分流策略已应用 (2025 更新列表)。${PLAIN}"
}

mode_global() {
    ensure_warp_exists || return
    local warp_rule=$(jq -n '{ "outbound": "WARP" }') 
    
    apply_routing_rule "$warp_rule"
    apply_routing_rule "$(get_anti_loop_rule)"
    echo -e "${GREEN}全局接管策略已应用。${PLAIN}"
}

mode_specific_node() {
    ensure_warp_exists || return
    local node_list=$(jq -r '.inbounds[] | "\(.tag) | \(.type)"' "$CONFIG_FILE" | nl)
    echo "$node_list"
    read -p "输入节点序号 (空格分隔): " selection
    local tags_json="[]"
    for num in $selection; do
        local tag=$(echo "$node_list" | sed -n "${num}p" | awk -F'|' '{print $1}' | awk '{print $2}')
        [[ -n "$tag" ]] && tags_json=$(echo "$tags_json" | jq --arg t "$tag" '. + [$t]')
    done
    
    if [[ "$tags_json" == "[]" ]]; then
        echo -e "${RED}未选择任何有效节点，请重新操作。${PLAIN}"
        return 1
    fi
    
    apply_routing_rule "$(jq -n --argjson ib "$tags_json" '{ "inbound": $ib, "outbound": "WARP" }')"
    echo -e "${GREEN}指定节点接管策略已应用。${PLAIN}"
}

uninstall_warp() {
    cp "$CONFIG_FILE" "${CONFIG_FILE}.bak_un"
    local TMP_CONF=$(mktemp)
    
    jq 'del(.outbounds[] | select(.tag == "WARP"))' "$CONFIG_FILE" > "$TMP_CONF" && mv "$TMP_CONF" "$CONFIG_FILE"
    jq 'del(.endpoints[] | select(.tag == "WARP"))' "$CONFIG_FILE" > "$TMP_CONF" && mv "$TMP_CONF" "$CONFIG_FILE"
    jq 'del(.route.rules[] | select(.outbound == "WARP"))' "$CONFIG_FILE" > "$TMP_CONF" && mv "$TMP_CONF" "$CONFIG_FILE"
    
    if [[ -f "$CRED_FILE" ]]; then
        read -p "是否删除保存的 WARP 凭证文件？(y/N): " del_cred
        if [[ "$del_cred" == "y" || "$del_cred" == "Y" ]]; then
            rm -f "$CRED_FILE"
            echo -e "${GREEN}WARP 凭证文件已删除。${PLAIN}"
        fi
    fi
    
    echo -e "${GREEN}WARP 卸载完成。${PLAIN}"
    restart_sb
}

# ==========================================
# 4. 自动化与入口
# ==========================================

show_menu() {
    check_dependencies
    while true; do
        clear
        local st="${RED}未配置${PLAIN}"
        if [[ -f "$CONFIG_FILE" ]]; then
            if jq -e '.endpoints[]? | select(.tag == "WARP")' "$CONFIG_FILE" >/dev/null 2>&1; then
                st="${GREEN}已配置 (v4.1 Ultimate)${PLAIN}"
            fi
        fi
        echo -e "================ Native WARP 管理中心 (Sing-box 1.12+) ================"
        echo -e " 当前配置状态: [$st]"
        echo -e "----------------------------------------------------"
        echo -e " 1. 配置 WARP 凭证 (自动/手动)"
        echo -e " 2. 查看当前凭证信息"
        echo -e " 3. 模式一：智能流媒体分流"
        echo -e " 4. 模式二：全局接管"
        echo -e " 5. 模式三：指定节点接管 (推荐)"
        echo -e " 7. 卸载 Native WARP"
        echo -e " 0. 返回上级菜单"
        read -p "请选择: " choice
        case "$choice" in
            1) echo -e "1. 自动; 2. 手动"; read -p "选: " t; [[ "$t" == "1" ]] && register_warp || manual_warp; read -p "回车继续..." ;;
            2) cat "$CRED_FILE" 2>/dev/null || echo "无凭证"; read -p "回车继续..." ;;
            3) mode_stream; read -p "回车继续..." ;;
            4) mode_global; read -p "回车继续..." ;;
            5) mode_specific_node; read -p "回车继续..." ;;
            7) uninstall_warp; read -p "回车继续..." ;;
            0) exit 0 ;;
            *) sleep 1 ;;
        esac
    done
}

auto_main() {
    echo -e "${GREEN}>>> [WARP-SB] 启动自动化部署 (v4.1 Ultimate)...${PLAIN}"
    check_dependencies
    if [[ -n "$WARP_PRIV_KEY" ]] && [[ -n "$WARP_IPV6" ]]; then
        save_credentials "$WARP_PRIV_KEY" "bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=" "172.16.0.2/32" "$WARP_IPV6" "${WARP_RESERVED:-[0,0,0]}"
        write_warp_config "$WARP_PRIV_KEY" "bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=" "172.16.0.2/32" "$WARP_IPV6" "${WARP_RESERVED:-[0,0,0]}"
    else
        register_warp
    fi

    local rule=""
    case "$WARP_MODE_SELECT" in
        1) rule=$(jq -n '{ "ip_version": 4, "outbound": "WARP" }') ;;
        2) rule=$(jq -n '{ "ip_version": 6, "outbound": "WARP" }') ;;
        3) [[ -n "$WARP_INBOUND_TAGS" ]] && rule=$(jq -n --argjson ib "$(echo "$WARP_INBOUND_TAGS" | jq -R 'split(",")')" '{ "inbound": $ib, "outbound": "WARP" }') ;;
        4) rule=$(jq -n '{ "outbound": "WARP" }') ;;
        *) rule=$(jq -n '{
                "domain_suffix": [
                    "netflix.com","nflxvideo.net","netflix.net",
                    "openai.com","chatgpt.com",
                    "google.com","youtube.com","youtu.be",
                    "disneyplus.com","hulu.com",
                    "spotify.com","scdn.co","spotifycdn.com","pscp.tv"
                ],
                "outbound": "WARP"
            }') ;;
    esac
    
    if [[ -n "$rule" ]]; then
        apply_routing_rule "$rule"
    fi
    apply_routing_rule "$(get_anti_loop_rule)"
    
    echo -e "${GREEN}>>> [WARP-SB] 自动化配置完成。${PLAIN}"
}

if [[ "$AUTO_SETUP" == "true" ]]; then auto_main; else show_menu; fi