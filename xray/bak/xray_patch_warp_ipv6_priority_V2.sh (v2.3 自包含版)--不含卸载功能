#!/bin/bash
# ============================================================
#  Xray IPv6 优先 + WARP 兜底补丁 (v2.3 自包含版)--不含卸载功能
#  - 新增: 自带手动 WARP 凭证配置 + 自动注入 warp-out
#  - 新增: 三态状态显示 + 循环菜单
#  - 升级点: 增加 Xray 配置预检，防止配置错误导致失联
#  - 升级点: 增强直连标签探测，防止流量黑洞
# ============================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
SKYBLUE='\033[0;36m'
PLAIN='\033[0m'

CONFIG_FILE="/usr/local/etc/xray/config.json"
BACKUP_FILE="${CONFIG_FILE}.ipv6_patch.bak"
XRAY_BIN="/usr/local/bin/xray" # 可根据实际情况调整
CRED_FILE="/etc/xray/warp_credentials.conf"   # 新增：凭证保存路径
XRAY_BIN=$(command -v xray || echo "/usr/local/bin/xray")  # 增强路径灵活性，兜底硬编码路径

[[ $EUID -ne 0 ]] && echo -e "${RED}错误: 必须使用 root 用户运行此脚本！${PLAIN}" && exit 1

# ==================== 新增：手动输入 WARP 凭证 ====================
manual_warp_input() {
    local def_key="" def_v4="" def_v6="" def_res=""
    if [[ -f "$CRED_FILE" ]]; then
        source "$CRED_FILE" 2>/dev/null
        def_key="$PRIV_KEY"
        def_v4="$V4_ADDR"
        def_v6="$V6_ADDR"
        def_res="$RESERVED"
    fi

    echo -e "${SKYBLUE}=== WARP 手动配置（首次必填，后续可直接回车）===${PLAIN}"
    read -p "私钥 [默认: ${def_key:0:10}...]: " priv_key
    priv_key=${priv_key:-$def_key}
    [[ -z "$priv_key" ]] && { echo -e "${RED}私钥必填！${PLAIN}"; return 1; }

    read -p "内网 IPv4 [默认: 172.16.0.2/32]: " v4
    v4=${v4:-"172.16.0.2/32"}

    read -p "内网 IPv6 [默认: ${def_v6}]: " v6
    v6=${v6:-$def_v6}
    [[ -z "$v6" ]] && { echo -e "${RED}IPv6 地址必填！${PLAIN}"; return 1; }

    read -p "Reserved [默认: ${def_res:-0,0,0}]: " res_input
    res_input=${res_input:-"${def_res:-0,0,0}"}

    # 处理 Reserved
    if [[ "$res_input" =~ ^[0-9,]+$ ]]; then
        reserved="[${res_input}]"
    elif [[ "$res_input" =~ ^\[.*\]$ ]]; then
        reserved="$res_input"
    else
        reserved="[0,0,0]"
    fi

    mkdir -p "$(dirname "$CRED_FILE")"
    cat > "$CRED_FILE" <<EOF
PRIV_KEY="$priv_key"
V4_ADDR="$v4"
V6_ADDR="$v6"
RESERVED="$reserved"
EOF

    echo -e "${GREEN}WARP 凭证已保存。${PLAIN}"
    return 0
}

# ==================== 新增：自动注入 warp-out ====================
inject_warp_outbound() {
    source "$CRED_FILE" 2>/dev/null
    [[ -z "$PRIV_KEY" || -z "$V6_ADDR" ]] && { echo -e "${RED}凭证加载失败！${PLAIN}"; return 1; }

    local v4="${V4_ADDR:-""}"
    local v6="$V6_ADDR"
    local key="$PRIV_KEY"
    local res="$RESERVED"

    [[ ! "$v4" =~ "/" && -n "$v4" ]] && v4="${v4}/32"
    [[ ! "$v6" =~ "/" ]] && v6="${v6}/128"

    local addr="[\"$v6\""
    [[ -n "$v4" ]] && addr="$addr,\"$v4\""
    addr="$addr]"

    # 环境自适应 endpoint
    local endpoint="engage.cloudflareclient.com:2408"
    local ipv4_check=$(curl -4 -s -m 3 http://ip.sb 2>/dev/null)
    [[ ! "$ipv4_check" =~ ^[0-9.]+$ ]] && endpoint="2606:4700:d0::a29f:c001:2408"

    local warp_json=$(jq -n \
        --arg key "$key" \
        --argjson addr "$addr" \
        --argjson res "$res" \
        --arg ep "$endpoint" \
        '{
            "tag": "warp-out",
            "protocol": "wireguard",
            "settings": {
                "secretKey": $key,
                "address": $addr,
                "peers": [{
                    "publicKey": "bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=",
                    "endpoint": $ep,
                    "reserved": $res,
                    "mtu": 1280
                }]
            }
        }')

    cp "$CONFIG_FILE" "${CONFIG_FILE}.bak_warp"
    local tmp=$(mktemp)

    # 先删除旧的 warp-out（防止重复）
    jq 'del(.outbounds[] | select(.tag == "warp-out"))' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
    # 注入新的
    jq --argjson w "$warp_json" '.outbounds += [$w]' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"

    # === 新增：注入 anti-loop 规则，防止访问 Cloudflare 相关域名走 WARP 导致死循环 ===
    local anti_loop_json=$(jq -n '{
        "type": "field",
        "domain": ["engage.cloudflareclient.com", "cloudflare.com", "www.cloudflare.com"],
        "outboundTag": "'"$direct_tag"'"
    }')
    jq --argjson al "$anti_loop_json" '.routing.rules = [$al] + .routing.rules' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"

    echo -e "${GREEN}warp-out 已自动注入。${PLAIN}"
}

get_direct_tag() {
    local tag
    tag=$(jq -r '.outbounds[] | select(.tag == "direct") | .tag' "$CONFIG_FILE" 2>/dev/null)
    if [[ -z "$tag" ]]; then
        tag=$(jq -r '.outbounds[] | select(.tag == "freedom") | .tag' "$CONFIG_FILE" 2>/dev/null)
    fi
    if [[ -z "$tag" ]]; then
        tag=$(jq -r '.outbounds[] | select(.protocol == "freedom") | .tag' "$CONFIG_FILE" | head -n 1 2>/dev/null)
    fi
    
    if [[ -z "$tag" ]]; then
        echo -e "${RED}严重错误: 无法自动识别直连(Freedom)出站 Tag。${PLAIN}"
        echo -e "${YELLOW}请手动检查配置文件 outbounds 部分。${PLAIN}"
        exit 1
    fi
    echo "$tag"
}

inject_rule() {
    # === 新增：自动确保 warp-out 存在 ===
    if ! jq -e '.outbounds[] | select(.tag == "warp-out")' "$CONFIG_FILE" >/dev/null 2>&1; then
        if [[ -f "$CRED_FILE" ]]; then
            echo -e "${YELLOW}检测到已有 WARP 凭证，自动注入 warp-out...${PLAIN}"
            inject_warp_outbound || return 1
        else
            echo -e "${YELLOW}未找到 warp-out，也无凭证文件，进入手动配置...${PLAIN}"
            manual_warp_input || return 1
            inject_warp_outbound || return 1
        fi
    fi
    # === 新增结束 ===

    echo -e "${YELLOW}读取节点列表...${PLAIN}"
    local direct_tag=$(get_direct_tag)
    echo -e "${GREEN}自动识别直连出站为: ${direct_tag}${PLAIN}"

    local node_list=$(jq -r '.inbounds[] | select(.protocol != "dokodemo-door" and .tag != "api") | "\(.tag) | \(.protocol)"' "$CONFIG_FILE" | nl)
    
    if [[ -z "$node_list" ]]; then echo -e "${RED}无有效入站节点。${PLAIN}"; return 1; fi
    
    echo -e "------------------------------------------------"
    echo "$node_list"
    echo -e "------------------------------------------------"
    echo -e "${SKYBLUE}请选择要开启 [IPv6优先+IPv4兜底] 的节点序号${PLAIN}"
    echo -e "(支持多选，用空格分隔，例如: 1 3)"
    read -p "输入序号: " selection
    
    local tags_list=()
    for num in $selection; do
        local tag=$(echo "$node_list" | sed -n "${num}p" | awk -F'|' '{print $1}' | awk '{print $2}')
        if [[ -n "$tag" ]]; then
            tags_list+=("$tag")
            echo -e "已选中: ${GREEN}${tag}${PLAIN}"
        fi
    done
    
    if [[ ${#tags_list[@]} -eq 0 ]]; then
        echo -e "${RED}未选中任何有效节点。${PLAIN}"; return 1
    fi
    
    local tags_json=$(printf '%s\n' "${tags_list[@]}" | jq -R . | jq -s .)

    echo -e "${YELLOW}正在注入聚合规则...${PLAIN}"
    cp "$CONFIG_FILE" "$BACKUP_FILE"
    
    local rule_v6=$(jq -n --argjson t "$tags_json" --arg dt "$direct_tag" '{ 
        "type": "field", "inboundTag": $t, "ip": ["::/0"], "outboundTag": $dt 
    }')
    local rule_v4=$(jq -n --argjson t "$tags_json" '{ 
        "type": "field", "inboundTag": $t, "ip": ["0.0.0.0/0"], "outboundTag": "warp-out" 
    }')
    
    jq --argjson r1 "$rule_v6" --argjson r2 "$rule_v4" \
       '.routing.rules = [$r1, $r2] + .routing.rules' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp"
    
    if [[ -f "$XRAY_BIN" ]]; then
        echo -e "${YELLOW}正在进行 Xray 配置预检...${PLAIN}"
        if ! "$XRAY_BIN" run -test -conf "${CONFIG_FILE}.tmp" >/dev/null 2>&1; then
            echo -e "${RED}配置预检失败！生成的 JSON 存在语法错误。已终止操作。${PLAIN}"
            rm "${CONFIG_FILE}.tmp"
            return 1
        fi
    fi

    mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
    
    if systemctl restart xray; then
        echo -e "${GREEN}补丁应用成功！${PLAIN}"
        echo -e "策略已生效: 选中的 ${#tags_list[@]} 个节点已启用双栈分流策略。"
        echo -e "IPv6 -> ${direct_tag} | IPv4 -> warp-out"
    else
        echo -e "${RED}重启失败，配置已回滚。${PLAIN}"
        cp "$BACKUP_FILE" "$CONFIG_FILE"
        systemctl restart xray
    fi
}

# ==================== 主菜单（带三态显示）===================
while true; do
    clear
    local st="${RED}未配置${PLAIN}"
    local has_cred=false

    if [[ -f "$CRED_FILE" ]]; then
        if grep -q "PRIV_KEY" "$CRED_FILE" && grep -q "V6_ADDR" "$CRED_FILE"; then
            has_cred=true
        fi
    fi

    if [[ -f "$CONFIG_FILE" ]] && jq -e '.outbounds[] | select(.tag == "warp-out")' "$CONFIG_FILE" >/dev/null 2>&1; then
        st="${GREEN}已配置（WARP 运行中）${PLAIN}"
    elif $has_cred; then
        st="${YELLOW}凭证已保存（未启用 WARP）${PLAIN}"
    fi

    echo -e "============================================"
    echo -e " Xray IPv6 优先 + WARP 兜底补丁 (v2.3 自包含版)"
    echo -e "--------------------------------------------"
    echo -e " 当前状态: [$st]"
    if [[ "$st" == *"未启用"* ]]; then
        echo -e "${YELLOW}提示：选择 1 可自动启用 WARP 并应用策略${PLAIN}"
    fi
    echo -e " 1. 应用 IPv6 优先 + IPv4 WARP 兜底策略"
    echo -e " 2. 手动配置 WARP 凭证（首次必填，后续回车跳过）"
    echo -e " 0. 退出"
    echo -e "============================================"
    read -p "请选择: " choice

    case "$choice" in
        1) inject_rule; read -p "按回车继续..." ;;
        2) manual_warp_input; read -p "配置完成，按回车继续..." ;;
        0) exit 0 ;;
        *) echo -e "${RED}无效选项${PLAIN}"; sleep 1 ;;
    esac
done