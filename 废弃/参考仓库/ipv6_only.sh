# ==============================================================================
# æ¨¡å—ï¼šIPv6-Only ç½‘ç»œæ•‘æ˜Ÿ (NAT64/DNS64)
# åŠŸèƒ½ï¼šè‡ªåŠ¨æ£€æµ‹æ˜¯å¦ç¼ºå¤± IPv4 è®¿é—®èƒ½åŠ›ï¼Œå¹¶æ³¨å…¥ DNS64 æœåŠ¡ä»¥å®ç°è®¿é—® IPv4 ç½‘ç»œ
# æ¥æºå‚è€ƒï¼šTrex.fi å…¬å…± NAT64 æœåŠ¡
# ==============================================================================

enable_nat64() {
    # 1. æ£€æµ‹ï¼šå¦‚æœæœºå™¨æœ¬èº«æœ‰ IPv4 è¿æ¥èƒ½åŠ›ï¼Œåˆ™ç›´æ¥è·³è¿‡ï¼Œä¸ç”»è›‡æ·»è¶³
    # å°è¯•è¿æ¥ Cloudflare çš„ IPv4 DNS (1.1.1.1) æˆ– Google (8.8.8.8)
    if curl -4 -s --connect-timeout 3 https://1.1.1.1 >/dev/null 2>&1; then
        echo "âœ… æ£€æµ‹åˆ°åŸç”Ÿ IPv4 ç½‘ç»œï¼Œæ— éœ€ NAT64 ä¼˜åŒ–ã€‚"
        return
    fi

    echo "âš ï¸  æ£€æµ‹åˆ°çº¯ IPv6 ç¯å¢ƒ (IPv6-Only)ï¼Œæ­£åœ¨é…ç½® NAT64/DNS64..."

    # 2. å¤‡ä»½ï¼šä¿®æ”¹å‰å…ˆå¤‡ä»½ç³»ç»ŸåŸæœ‰çš„ DNS é…ç½® (å¥½ä¹ æƒ¯)
    if [ ! -f "/etc/resolv.conf.bak.nat64" ]; then
        cp /etc/resolv.conf /etc/resolv.conf.bak.nat64
        echo "ğŸ“¦ åŸ DNS é…ç½®å·²å¤‡ä»½è‡³ /etc/resolv.conf.bak.nat64"
    fi

    # 3. æ³¨å…¥ï¼šå†™å…¥ Trex çš„å…¬å…± DNS64 æœåŠ¡åœ°å€
    # 2001:67c:2b0::4 å’Œ 2001:67c:2b0::6 æ˜¯ç›®å‰æœ€ç¨³å®šçš„å…¬å…± NAT64 DNS
    # å®ƒä»¬ä¼šè‡ªåŠ¨æŠŠ IPv4 åŸŸåè§£æä¸ºå‡çš„ IPv6 åœ°å€ï¼Œä»è€Œè®©ä½ çš„æœºå™¨èƒ½è¿æ¥
    echo -e "nameserver 2001:67c:2b0::4\nnameserver 2001:67c:2b0::6" > /etc/resolv.conf

    # 4. éªŒè¯
    echo "âœ… NAT64/DNS64 é…ç½®å®Œæˆï¼"
    echo "ğŸ”„ æ­£åœ¨æµ‹è¯• IPv4 è¿é€šæ€§ (è®¿é—® Google)..."
    if curl -4 -s --connect-timeout 5 https://www.google.com >/dev/null 2>&1; then
        echo "ğŸ‰ æˆåŠŸï¼ä½ çš„ IPv6 å°é¸¡ç°åœ¨å¯ä»¥è®¿é—® IPv4 ç½‘ç»œäº†ã€‚"
    else
        echo "âŒ è­¦å‘Šï¼šNAT64 é…ç½®åä»æ— æ³•è¿æ¥ï¼Œå¯èƒ½é˜²ç«å¢™æ‹¦æˆªäº† UDP 53 ç«¯å£ã€‚"
    fi
}

# --- å¯é€‰ï¼šè¿˜åŸå‡½æ•° (å¸è½½æ—¶ç”¨) ---
restore_dns() {
    if [ -f "/etc/resolv.conf.bak.nat64" ]; then
        cp /etc/resolv.conf.bak.nat64 /etc/resolv.conf
        rm -f /etc/resolv.conf.bak.nat64
        echo "âœ… å·²è¿˜åŸåŸå§‹ DNS é…ç½®ã€‚"
    fi
}
