#!/bin/sh

echo "ðŸ›‘ æ¸…ç†æ—§é…ç½®..."
rc-service cloudflared stop >/dev/null 2>&1
killall cloudflared >/dev/null 2>&1

# è¿™æ˜¯ä»Žä½ æ—¥å¿—é‡Œæå–çš„ Token
MY_TOKEN="eyJhIjoiYWYzN2NhNDc5NDRkMDFlNGY1NTQ2ZmU2NWIyMzRlNjQiLCJ0IjoiNWU5MDYwMjMtMzUxMC00MTZlLWI5MjUtMDQ5YmRmNDA1OWVkIiwicyI6Ik1qYzFPVE5oWlRrdE5HRTRNUzAwWkRjNUxXRmpNRGd0TlRGa1pqSmpZemRrTjJJeiJ9"

echo "ðŸ“ å†™å…¥ç²¾ç®€ç‰ˆé…ç½®æ–‡ä»¶ (ç§»é™¤æŠ¥é”™å‚æ•°)..."
mkdir -p /etc/cloudflared
# æ³¨æ„ï¼šè¿™é‡Œåªä¿ç•™ç»å¯¹ä¸ä¼šæŠ¥é”™çš„å­—æ®µ
cat > /etc/cloudflared/config.yml <<YAML
tunnel: "$MY_TOKEN"
logfile: "/var/log/cloudflared.log"
loglevel: "info"
YAML

echo "âš™ï¸ é‡å†™å¯åŠ¨æœåŠ¡ (ä½¿ç”¨çŽ¯å¢ƒå˜é‡å¼ºåˆ¶ IPv6)..."
cat > /etc/init.d/cloudflared <<INIT
#!/sbin/openrc-run

name="cloudflared"
description="Cloudflare Tunnel Agent"
command="/usr/bin/cloudflared"
command_args="tunnel run --config /etc/cloudflared/config.yml"
command_background=true
pidfile="/run/cloudflared.pid"
output_log="/var/log/cloudflared.log"
error_log="/var/log/cloudflared.err"

depend() {
    need net
    after firewall
}

start_pre() {
    # æ ¸å¿ƒä¿®æ”¹ï¼šé€šè¿‡çŽ¯å¢ƒå˜é‡ä¼ é€’å‚æ•°ï¼Œç»•è¿‡é…ç½®æ–‡ä»¶è§£æž bug
    export TUNNEL_EDGE_IP_VERSION="6"
    export TUNNEL_PROTOCOL="http2"
}
INIT
chmod +x /etc/init.d/cloudflared

echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
rc-service cloudflared restart
sleep 5

echo "ðŸ“Š æ£€æŸ¥æ—¥å¿—..."
if grep -q "expected string found int" /var/log/cloudflared.err; then
    echo "âŒ è¿˜æ˜¯æŠ¥é”™é…ç½®æ ¼å¼é—®é¢˜ (è§é¬¼äº†)"
elif grep -q "Registered tunnel connection" /var/log/cloudflared.err /var/log/cloudflared.log; then
    echo "âœ…âœ…âœ… ç»ˆäºŽæˆåŠŸäº†ï¼Tunnel å·²è¿žæŽ¥ï¼"
else
    echo "â„¹ï¸ è¯·æŸ¥çœ‹æœ€æ–°æ—¥å¿—ï¼š"
    echo "--------------------------------"
    tail -n 10 /var/log/cloudflared.err
fi
