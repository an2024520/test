cat > fix.sh << 'EOF'
#!/bin/sh

# é¢œè‰²è®¾ç½®
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

echo -e "${GREEN}=== Cloudflare Tunnel ç»ˆæä¿®å¤è„šæœ¬ ===${NC}"

# 1. åœæ­¢æ—§æœåŠ¡
echo "ğŸ›‘ åœæ­¢æ—§æœåŠ¡..."
rc-service cloudflared stop >/dev/null 2>&1
killall cloudflared >/dev/null 2>&1

# 2. äº¤äº’å¼è¾“å…¥ Token
echo ""
echo -e "${GREEN}è¯·ç²˜è´´æ‚¨çš„ Cloudflare Tunnel Token:${NC}"
echo -e "(ä»¥ ${RED}eyJh${NC} å¼€å¤´çš„é•¿å­—ç¬¦ä¸²)"
printf "Token: "
read -r MY_TOKEN

# æ£€æŸ¥ Token
if [ -z "$MY_TOKEN" ]; then
    echo -e "${RED}âŒ é”™è¯¯ï¼šToken ä¸èƒ½ä¸ºç©ºï¼${NC}"
    exit 1
fi

if ! echo "$MY_TOKEN" | grep -q "^eyJh"; then
    echo -e "${RED}âš ï¸ è­¦å‘Šï¼šToken æ ¼å¼çœ‹èµ·æ¥ä¸å¯¹ (ä¸æ˜¯ eyJh å¼€å¤´)ã€‚${NC}"
    echo "ä½†æˆ‘ä»¬å°†ç»§ç»­å°è¯•..."
fi

# 3. å†™å…¥é…ç½®æ–‡ä»¶ (ä¿®å¤ int/string æ ¼å¼é—®é¢˜)
echo ""
echo "âš™ï¸ å†™å…¥é…ç½®æ–‡ä»¶ /etc/cloudflared/config.yml ..."
mkdir -p /etc/cloudflared

# æ³¨æ„ï¼šedge-ip-version å¿…é¡»åŠ å¼•å· "6"
cat > /etc/cloudflared/config.yml <<CONFIG
tunnel: $MY_TOKEN
edge-ip-version: "6"
protocol: http2
logfile: /var/log/cloudflared.log
loglevel: info
CONFIG

# 4. é‡å†™å¯åŠ¨æœåŠ¡ (å¼ºåˆ¶è¯»å–é…ç½®æ–‡ä»¶)
echo "ğŸ”§ ä¿®å¤ OpenRC å¯åŠ¨è„šæœ¬..."
cat > /etc/init.d/cloudflared <<INIT
#!/sbin/openrc-run

name="cloudflared"
description="Cloudflare Tunnel Agent"
command="/usr/bin/cloudflared"
command_args="tunnel run"
command_background=true
pidfile="/run/cloudflared.pid"
output_log="/var/log/cloudflared.log"
error_log="/var/log/cloudflared.err"

depend() {
    need net
    after firewall
}
INIT
chmod +x /etc/init.d/cloudflared

# 5. å¯åŠ¨å¹¶éªŒè¯
echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
rc-service cloudflared restart
sleep 5

echo ""
echo "ğŸ“Š æ£€æŸ¥è¿è¡ŒçŠ¶æ€..."
if grep -q "Registered tunnel connection" /var/log/cloudflared.err /var/log/cloudflared.log 2>/dev/null; then
    echo -e "${GREEN}âœ…âœ…âœ… æ­å–œï¼Tunnel å·²æˆåŠŸè¿æ¥ï¼${NC}"
    echo "æ‚¨çš„èŠ‚ç‚¹åº”è¯¥å·²ç»æ¢å¤æ­£å¸¸ã€‚"
else
    echo -e "${RED}âš ï¸ æœªæ£€æµ‹åˆ°è¿æ¥æˆåŠŸæ ‡å¿—ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹æ—¥å¿—ï¼š${NC}"
    echo "------------------------------------------------"
    tail -n 10 /var/log/cloudflared.err
fi
EOF
