cat << 'EOF' > fix_nat64.sh
#!/bin/bash

# å®šä¹‰å…¬å…± NAT64 æœåŠ¡åˆ—è¡¨ (æœåŠ¡å•† | IPv6åœ°å€)
# 1. August Internet (é€šå¸¸æœ€ç¨³)
DNS_AUGUST="2a09:c500::1"
# 2. Trex.fi (å¤‡ç”¨ï¼ŒèŠ¬å…°)
DNS_TREX="2001:67c:2b0::4"
# 3. Kasper (ä¸¹éº¦ï¼Œå¤‡ç”¨)
DNS_KASPER="2a05:d014:527:104::104"

echo "========================================="
echo "   NAT64 è‡ªåŠ¨è½®è¯¢ä¿®å¤å·¥å…· (IPv6-Only)"
echo "========================================="

# 1. å…ˆè§£é”æ–‡ä»¶ï¼Œé˜²æ­¢æ— æ³•ä¿®æ”¹
chattr -i /etc/resolv.conf >/dev/null 2>&1
# åœæ­¢ systemd-resolved é˜²æ­¢å¹²æ‰° (Debian/Ubuntu å¸¸è§é—®é¢˜)
systemctl stop systemd-resolved >/dev/null 2>&1
systemctl disable systemd-resolved >/dev/null 2>&1

# 2. å®šä¹‰æµ‹è¯•å‡½æ•°
test_dns() {
    local dns_ip=$1
    local provider_name=$2
    
    echo -n "æ­£åœ¨å°è¯• [$provider_name] ($dns_ip) ... "
    
    # æš´åŠ›å†™å…¥
    rm -f /etc/resolv.conf
    echo "nameserver $dns_ip" > /etc/resolv.conf
    
    # æµ‹è¯•è¿žæŽ¥ (è¶…æ—¶æ—¶é—´è®¾ç½®çŸ­ä¸€ç‚¹ï¼Œ3ç§’)
    # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æµ‹è¯• ipv4.google.comï¼Œç¡®ä¿ DNS64 ç”Ÿæ•ˆ
    if curl -I -s --connect-timeout 3 https://ipv4.google.com >/dev/null 2>&1; then
        echo "âœ… é€šäº†ï¼"
        return 0
    else
        echo "âŒ å¤±è´¥"
        return 1
    fi
}

# 3. å¼€å§‹è½®è¯¢
SUCCESS=0
if test_dns "$DNS_AUGUST" "August Internet"; then
    SUCCESS=1
elif test_dns "$DNS_TREX" "Trex.fi"; then
    SUCCESS=1
elif test_dns "$DNS_KASPER" "Kasper"; then
    SUCCESS=1
fi

# 4. ç»“æžœå¤„ç†
if [ $SUCCESS -eq 1 ]; then
    echo "-----------------------------------------"
    echo "ðŸŽ‰ æ‰¾åˆ°å¯ç”¨çš„ NAT64 æœåŠ¡ï¼"
    echo "æ­£åœ¨é”å®šé…ç½®æ–‡ä»¶ï¼Œé˜²æ­¢ä¸¢å¤±..."
    chattr +i /etc/resolv.conf
    echo "âœ… /etc/resolv.conf å·²é”å®š (chattr +i)"
    echo "çŽ°åœ¨ä½ å¯ä»¥é‡æ–°è¿è¡Œ menu.sh è„šæœ¬äº†ã€‚"
else
    echo "-----------------------------------------"
    echo "ðŸ˜± å…¨éƒ¨å¤±è´¥ï¼"
    echo "å¯èƒ½åŽŸå› ï¼š"
    echo "1. ä½ çš„ VPS é˜²ç«å¢™å±è”½äº† UDP 53 ç«¯å£å‡ºç«™ã€‚"
    echo "2. ä½ çš„ VPS æœ¬èº« IPv6 ç½‘ç»œæ•…éšœ (å°è¯• curl -6 google.com çœ‹çœ‹é€šä¸é€š)ã€‚"
    
    # æ¢å¤ä¸€ä¸ªé»˜è®¤å€¼æ–¹ä¾¿æŽ’æŸ¥
    echo "nameserver 2a09:c500::1" > /etc/resolv.conf
fi
EOF

chmod +x fix_nat64.sh
./fix_nat64.sh
