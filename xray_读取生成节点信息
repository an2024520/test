#!/bin/bash

# ============================================================
#  模块四：节点信息读取 (调试修复版)
# ============================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
PLAIN='\033[0m'

CONFIG_FILE="/usr/local/etc/xray/config.json"
# 确保这里是你的 Xray 真实路径
XRAY_BIN="/usr/local/bin/xray_core/xray"

echo -e "${YELLOW}>>> 正在进行自检...${PLAIN}"

# 1. 检查 Xray 核心能不能运行
if [[ ! -f "$XRAY_BIN" ]]; then
    echo -e "${RED}[错误] 找不到 Xray 文件: $XRAY_BIN ${PLAIN}"
    echo -e "尝试自动搜索 xray..."
    XRAY_BIN=$(which xray)
    if [[ -z "$XRAY_BIN" ]]; then
        echo -e "${RED}[致命错误] 系统里没找到 xray 命令！无法计算公钥。${PLAIN}"
        exit 1
    fi
    echo -e "${GREEN}[成功] 找到 xray: $XRAY_BIN${PLAIN}"
else
    echo -e "${GREEN}[成功] Xray 路径正常: $XRAY_BIN${PLAIN}"
fi

# 2. 检查配置文件
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo -e "${RED}[错误] 找不到配置文件: $CONFIG_FILE${PLAIN}"
    exit 1
fi

echo -e "${YELLOW}>>> 开始提取节点...${PLAIN}"

PUBLIC_IP=$(curl -s4 ifconfig.me)
[[ -z "$PUBLIC_IP" ]] && PUBLIC_IP="[你的IP]"

for row in $(jq -r '.inbounds[] | @base64' "$CONFIG_FILE"); do
    _jq() { echo ${row} | base64 --decode | jq -r ${1}; }

    PROTOCOL=$(_jq '.protocol')
    
    if [[ "$PROTOCOL" == "vless" ]]; then
        TAG=$(_jq '.tag')
        PORT=$(_jq '.port')
        UUID=$(_jq '.settings.clients[0].id')
        NETWORK=$(_jq '.streamSettings.network')
        SECURITY=$(_jq '.streamSettings.security')
        
        echo -e "\n${CYAN}---------- 正在分析节点: $TAG ----------${PLAIN}"

        if [[ "$SECURITY" == "reality" ]]; then
            # 1. 读取私钥
            PRIVATE_KEY=$(_jq '.streamSettings.realitySettings.privateKey')
            echo -e "读取到的私钥 (前5位): ${GREEN}${PRIVATE_KEY:0:5}***${PLAIN}"

            # 2. 暴力尝试计算公钥 (显示原始输出)
            echo -e "正在尝试反推公钥..."
            
            # 方法A: 标准路径计算
            RAW_OUTPUT=$($XRAY_BIN x25519 -i "$PRIVATE_KEY" 2>&1)
            
            # 调试：打印原始输出，看看到底算出来没
            # echo -e "Xray内核返回原始信息: $RAW_OUTPUT" 

            # 提取公钥 (尝试多种匹配模式)
            # 匹配 "Public key: XXXXX" 或 "Public: XXXXX"
            PUBLIC_KEY=$(echo "$RAW_OUTPUT" | grep -i "Public" | awk -F ": " '{print $2}' | tr -d ' \r\n')

            if [[ -z "$PUBLIC_KEY" ]]; then
                 echo -e "${RED}[失败] 公钥计算结果为空！${PLAIN}"
                 echo -e "${YELLOW}可能原因: 私钥格式错误 或 Xray版本不支持此命令。${PLAIN}"
                 echo -e "Xray返回的错误信息: ${RED}$RAW_OUTPUT${PLAIN}"
                 PUBLIC_KEY="<公钥计算失败>"
            else
                 echo -e "${GREEN}[成功] 反推公钥: $PUBLIC_KEY${PLAIN}"
            fi
            
            # 获取其他参数
            SNI=$(_jq '.streamSettings.realitySettings.serverNames[0]')
            SHORT_ID=$(_jq '.streamSettings.realitySettings.shortIds[0]')
            [[ "$SHORT_ID" == "null" ]] && SHORT_ID=""

            # --- 生成 OpenClash 配置 ---
            echo -e "${YELLOW}➤ OpenClash 配置片段:${PLAIN}"
            echo -e "  - name: \"${TAG}\""
            echo -e "    type: vless"
            echo -e "    server: ${PUBLIC_IP}"
            echo -e "    port: ${PORT}"
            echo -e "    uuid: ${UUID}"
            echo -e "    network: ${NETWORK}"
            echo -e "    tls: true"
            echo -e "    udp: true"
            if [[ "$NETWORK" == "tcp" ]]; then
                echo -e "    flow: xtls-rprx-vision"
            else
                echo -e "    # flow: (非tcp协议不填flow)"
            fi
            echo -e "    servername: ${SNI}"
            echo -e "    client-fingerprint: chrome"
            echo -e "    reality-opts:"
            echo -e "      public-key: ${PUBLIC_KEY}"
            echo -e "      short-id: ${SHORT_ID}"
            if [[ "$NETWORK" == "xhttp" ]]; then
                PATH_VAL=$(_jq '.streamSettings.xhttpSettings.path')
                echo -e "    xhttp-opts:"
                echo -e "      mode: auto"
                echo -e "      path: ${PATH_VAL}"
            fi
        else
            echo -e "${YELLOW}跳过: 不是 Reality 节点${PLAIN}"
        fi
    fi
done
echo -e "\n${CYAN}----------------------------------------${PLAIN}"
