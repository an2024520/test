#!/bin/bash

# ============================================================
#  模块四：节点信息读取 (v3.0 兼容修复版)
# ============================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
PLAIN='\033[0m'

CONFIG_FILE="/usr/local/etc/xray/config.json"
XRAY_BIN="/usr/local/bin/xray_core/xray"

# 1. 环境检查
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo -e "${RED}[错误] 找不到配置文件: $CONFIG_FILE${PLAIN}"
    exit 1
fi

echo -e "${YELLOW}>>> 正在解析节点信息...${PLAIN}"
PUBLIC_IP=$(curl -s4 ifconfig.me)
[[ -z "$PUBLIC_IP" ]] && PUBLIC_IP="[你的服务器IP]"

# 2. 遍历节点
for row in $(jq -r '.inbounds[] | @base64' "$CONFIG_FILE"); do
    _jq() { echo ${row} | base64 --decode | jq -r ${1}; }

    PROTOCOL=$(_jq '.protocol')
    
    if [[ "$PROTOCOL" == "vless" ]]; then
        TAG=$(_jq '.tag')
        PORT=$(_jq '.port')
        UUID=$(_jq '.settings.clients[0].id')
        NETWORK=$(_jq '.streamSettings.network')
        SECURITY=$(_jq '.streamSettings.security')
        
        # 只处理 Reality 节点
        if [[ "$SECURITY" == "reality" ]]; then
            PRIVATE_KEY=$(_jq '.streamSettings.realitySettings.privateKey')
            
            # --- 核心修复：兼容不同版本的 Xray 输出 ---
            # 1. 获取原始输出
            RAW_OUTPUT=$($XRAY_BIN x25519 -i "$PRIVATE_KEY" 2>&1)
            
            # 2. 优先尝试匹配 "Public" (标准版)
            PUBLIC_KEY=$(echo "$RAW_OUTPUT" | grep -i "Public" | awk -F ":" '{print $2}' | tr -d ' \r\n')
            
            # 3. 如果为空，尝试匹配 "Password" (特殊版本) <--- 这里修好了！
            if [[ -z "$PUBLIC_KEY" ]]; then
                PUBLIC_KEY=$(echo "$RAW_OUTPUT" | grep -i "Password" | awk -F ":" '{print $2}' | tr -d ' \r\n')
            fi

            # 4. 兜底检查
            if [[ -z "$PUBLIC_KEY" ]]; then
                 PUBLIC_KEY="[获取失败_请检查日志]"
            fi
            
            # 获取其他参数
            SNI=$(_jq '.streamSettings.realitySettings.serverNames[0]')
            SHORT_ID=$(_jq '.streamSettings.realitySettings.shortIds[0]')
            [[ "$SHORT_ID" == "null" ]] && SHORT_ID=""

            # --- 输出结果 ---
            echo -e "${CYAN}--------------------------------------------------${PLAIN}"
            echo -e "节点名称: ${YELLOW}${TAG}${PLAIN} | 协议: ${GREEN}${NETWORK}${PLAIN}"
            
            # -----------------------------------------------------
            # 场景 A: Vision (TCP)
            # -----------------------------------------------------
            if [[ "$NETWORK" == "tcp" ]]; then
                LINK="vless://${UUID}@${PUBLIC_IP}:${PORT}?security=reality&encryption=none&pbk=${PUBLIC_KEY}&fp=chrome&type=tcp&flow=xtls-rprx-vision&sni=${SNI}&sid=${SHORT_ID}#${TAG}-Vision"
                
                echo -e "${YELLOW}➤ OpenClash 配置 (Vision):${PLAIN}"
                echo -e "  - name: \"${TAG}-Vision\""
                echo -e "    type: vless"
                echo -e "    server: ${PUBLIC_IP}"
                echo -e "    port: ${PORT}"
                echo -e "    uuid: ${UUID}"
                echo -e "    network: tcp"
                echo -e "    tls: true"
                echo -e "    udp: true"
                echo -e "    flow: xtls-rprx-vision"
                echo -e "    servername: ${SNI}"
                echo -e "    client-fingerprint: chrome"
                echo -e "    reality-opts:"
                echo -e "      public-key: ${PUBLIC_KEY}"
                echo -e "      short-id: ${SHORT_ID}"
                
                echo -e "\n${YELLOW}➤ 分享链接 (v2rayN):${PLAIN}"
                echo -e "${LINK}"

            # -----------------------------------------------------
            # 场景 B: XHTTP
            # -----------------------------------------------------
            elif [[ "$NETWORK" == "xhttp" ]]; then
                PATH_VAL=$(_jq '.streamSettings.xhttpSettings.path')
                LINK="vless://${UUID}@${PUBLIC_IP}:${PORT}?security=reality&encryption=none&pbk=${PUBLIC_KEY}&fp=chrome&type=xhttp&path=${PATH_VAL}&mode=auto&sni=${SNI}&sid=${SHORT_ID}#${TAG}-XHTTP"

                echo -e "${YELLOW}➤ OpenClash 配置 (XHTTP):${PLAIN}"
                echo -e "  - name: \"${TAG}-XHTTP\""
                echo -e "    type: vless"
                echo -e "    server: ${PUBLIC_IP}"
                echo -e "    port: ${PORT}"
                echo -e "    uuid: ${UUID}"
                echo -e "    network: xhttp"
                echo -e "    tls: true"
                echo -e "    udp: true"
                echo -e "    # flow: 留空"
                echo -e "    servername: ${SNI}"
                echo -e "    client-fingerprint: chrome"
                echo -e "    reality-opts:"
                echo -e "      public-key: ${PUBLIC_KEY}"
                echo -e "      short-id: ${SHORT_ID}"
                echo -e "    xhttp-opts:"
                echo -e "      mode: auto"
                echo -e "      path: ${PATH_VAL}"

                echo -e "\n${YELLOW}➤ 分享链接 (v2rayN):${PLAIN}"
                echo -e "${LINK}"
            fi
        fi
    fi
done
echo -e "${CYAN}--------------------------------------------------${PLAIN}"
