#!/bin/sh

echo "âš”ï¸ å¯åŠ¨æœ€ç»ˆå†³æˆ˜æ¨¡å¼..."

# 1. åœæ­¢æœåŠ¡
rc-service cloudflared stop >/dev/null 2>&1
killall cloudflared >/dev/null 2>&1

# 2. ã€æ ¸å¿ƒæ“ä½œã€‘ç²¾å‡†çˆ†ç ´éšè—çš„é…ç½®æ–‡ä»¶
# æ—¢ç„¶ ls çœ‹ä¸åˆ°ï¼Œæˆ‘ä»¬ç›´æ¥ç›²åˆ ï¼Œå®å¯é”™æ€ä¸å¯æ”¾è¿‡
echo "ğŸ’£ æ­£åœ¨é”€æ¯éšè—çš„é…ç½®æ–‡ä»¶..."
rm -rf /root/.cloudflared
rm -rf /etc/cloudflared
rm -rf /home/alpine/.cloudflared  # <--- å°±æ˜¯å®ƒï¼ï¼ï¼
rm -f /usr/local/etc/cloudflared/config.yml
rm -f /usr/local/etc/cloudflared/config.yaml

# 3. å†æ¬¡æ£€æŸ¥ WireProxy (ä½ çš„æ•‘å‘½ç¨»è‰)
if ! netstat -an | grep -q "127.0.0.1:40000"; then
    echo "âš ï¸ WireProxy æœªè¿è¡Œï¼Œæ­£åœ¨å”¤é†’..."
    rc-service wireproxy restart >/dev/null 2>&1
    sleep 3
fi

# 4. å‡†å¤‡ Token (å·²è‡ªåŠ¨å¡«å…¥)
MY_TOKEN="eyJhIjoiYWYzN2NhNDc5NDRkMDFlNGY1NTQ2ZmU2NWIyMzRlNjQiLCJ0IjoiNWU5MDYwMjMtMzUxMC00MTZlLWI5MjUtMDQ5YmRmNDA1OWVkIiwicyI6Ik1qYzFPVE5oWlRrdE5HRTRNUzAwWkRjNUxXRmpNRGd0TlRGa1pqSmpZemRrTjJJeiJ9"

echo "âš™ï¸ éƒ¨ç½²ã€æ— é…ç½® + çº¯ä»£ç†ã€‘æ¨¡å¼..."
# æˆ‘ä»¬ä¸åˆ›å»º config.yml æ–‡ä»¶ï¼Œå½»åº•æœç»æ ¼å¼é”™è¯¯
cat > /etc/init.d/cloudflared <<INIT
#!/sbin/openrc-run

name="cloudflared"
description="Cloudflare Tunnel Agent"
command="/usr/bin/cloudflared"
# åªç”¨å‘½ä»¤è¡Œä¼  Tokenï¼Œä¸è¯»ä»»ä½•æ–‡ä»¶
command_args="tunnel run --token $MY_TOKEN"
command_background=true
pidfile="/run/cloudflared.pid"
output_log="/var/log/cloudflared.log"
error_log="/var/log/cloudflared.err"

depend() {
    need net
    after firewall
    need wireproxy
}

start_pre() {
    # === æ ¸å¿ƒé­”æ³•åŒº ===
    # å¼ºåˆ¶ Cloudflared èµ°æœ¬åœ° WireProxy (WARP) ä»£ç†
    export TUNNEL_PROXY_ADDRESS="127.0.0.1"
    export TUNNEL_PROXY_PORT="40000"
    
    # å¼ºåˆ¶ä½¿ç”¨ HTTP2 (TCP) åè®®ï¼Œé…åˆä»£ç†æ›´ç¨³
    export TUNNEL_PROTOCOL="http2"
}
INIT
chmod +x /etc/init.d/cloudflared

echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
rc-service cloudflared restart
sleep 6

echo "ğŸ“Š æœ€ç»ˆç»“æœ..."
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é‚£ä¸ªæŠ¥é”™
if grep -q "expected string found int" /var/log/cloudflared.err; then
    echo "âŒ ç»æœ›äº†ï¼šæŠ¥é”™è¿˜åœ¨ã€‚è¯·è¿è¡Œ 'rm -rf /home/*/.cloudflared' æ‰‹åŠ¨æ¸…ç†ã€‚"
elif grep -q "Registered tunnel connection" /var/log/cloudflared.err /var/log/cloudflared.log; then
    echo "ğŸ‰ğŸ‰ğŸ‰ èƒœåˆ©ï¼Cloudflared å·²æˆåŠŸè¿æ¥ï¼"
    echo "åŸç†ï¼šCloudflared -> 127.0.0.1:40000 (WireProxy) -> IPv4 ç½‘ç»œ"
    echo "ä½ çš„èŠ‚ç‚¹ç°åœ¨åº”è¯¥å·²ç»ç»¿äº†ï¼ˆHealthyï¼‰ã€‚"
else
    echo "â„¹ï¸ æŸ¥çœ‹æ—¥å¿—è¯¦æƒ…ï¼š"
    tail -n 10 /var/log/cloudflared.err
fi
