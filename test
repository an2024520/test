#!/bin/sh

echo "ðŸ•µï¸â€â™‚ï¸ å¯åŠ¨å…¨ç›˜æœç´¢æ¨¡å¼..."

# 1. åœæ­¢æœåŠ¡
rc-service cloudflared stop >/dev/null 2>&1
killall cloudflared >/dev/null 2>&1

# 2. æœç´¢å¹¶åˆ é™¤æ‰€æœ‰åä¸º config.yml æˆ– config.yaml çš„æ–‡ä»¶
# é‡ç‚¹æ‰«æ /root, /home, /etc, /usr
echo "ðŸ” æ­£åœ¨æœç´¢ç³»ç»Ÿä¸­çš„æ®‹ç•™é…ç½®æ–‡ä»¶..."

# æ‰“å°å‡ºæ¥ç»™ç”¨æˆ·çœ‹ä¸€çœ¼ (è®©ä½ æ­»ä¸ªæ˜Žç™½)
find /root /home /etc /usr -name "config.y*ml" 2>/dev/null

# æ‰§è¡Œåˆ é™¤
echo "ðŸ”¥ æ­£åœ¨é”€æ¯å‘çŽ°çš„æ‰€æœ‰é…ç½®æ–‡ä»¶..."
find /root /home /etc /usr -name "config.y*ml" -exec rm -rf {} + 2>/dev/null
# é¡ºä¾¿æ¸…ç†ä¸€ä¸‹ OpenRC å¯èƒ½çš„æ®‹ç•™é…ç½®
rm -f /etc/conf.d/cloudflared

# 3. å†æ¬¡ç¡®ä¿ WireProxy æ´»ç€
if ! netstat -an | grep -q "127.0.0.1:40000"; then
    echo "âš ï¸ WireProxy å¥½åƒæ²¡åœ¨è¿è¡Œï¼Œæ­£åœ¨é‡å¯å®ƒ..."
    rc-service wireproxy restart >/dev/null 2>&1
    sleep 2
fi

# 4. å‡†å¤‡ Token (ç¡¬ç¼–ç ï¼Œé˜²æ­¢å‡ºé”™)
MY_TOKEN="eyJhIjoiYWYzN2NhNDc5NDRkMDFlNGY1NTQ2ZmU2NWIyMzRlNjQiLCJ0IjoiNWU5MDYwMjMtMzUxMC00MTZlLWI5MjUtMDQ5YmRmNDA1OWVkIiwicyI6Ik1qYzFPVE5oWlRrdE5HRTRNUzAwWkRjNUxXRmpNRGd0TlRGa1pqSmpZemRrTjJJeiJ9"

echo "âš™ï¸ é‡æ–°éƒ¨ç½²æ— é…ç½®æ–‡ä»¶çš„å¯åŠ¨è„šæœ¬..."
# è¿™æ˜¯ä¸€ä¸ªçº¯å‡€çš„å¯åŠ¨è„šæœ¬ï¼Œä¸å¸¦ --configï¼Œåªé çŽ¯å¢ƒå˜é‡
cat > /etc/init.d/cloudflared <<INIT
#!/sbin/openrc-run

name="cloudflared"
description="Cloudflare Tunnel Agent"
command="/usr/bin/cloudflared"
# åªå¸¦ Tokenï¼Œä¸å¸¦ Config
command_args="tunnel run --token $MY_TOKEN"
command_background=true
pidfile="/run/cloudflared.pid"
output_log="/var/log/cloudflared.log"
error_log="/var/log/cloudflared.err"

depend() {
    need net
    after firewall
    need wireproxy
}

start_pre() {
    # å¼ºåˆ¶èµ°æœ¬åœ° WireProxy ä»£ç† (127.0.0.1:40000)
    export TUNNEL_PROXY_ADDRESS="127.0.0.1"
    export TUNNEL_PROXY_PORT="40000"
    # å¼ºåˆ¶åè®®ä¸º http2 (TCP)ï¼Œæ›´ç¨³
    export TUNNEL_PROTOCOL="http2"
}
INIT
chmod +x /etc/init.d/cloudflared

echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
rc-service cloudflared restart
sleep 5

echo "ðŸ“Š æœ€ç»ˆéªŒè¯..."
# æ­¤æ—¶åº”è¯¥ç»å¯¹ä¸ä¼šæœ‰æ ¼å¼é”™è¯¯äº†ï¼Œå› ä¸ºæ–‡ä»¶éƒ½è¢«åˆ å…‰äº†
if grep -q "expected string found int" /var/log/cloudflared.err; then
    echo "âŒ ç»æœ›äº†ï¼šè¿˜æ˜¯æŠ¥é”™ï¼è¿™è¯´æ˜Ž env vars å¯èƒ½æ²¡ç”Ÿæ•ˆï¼Œæˆ–è€…äºŒè¿›åˆ¶æ–‡ä»¶æœ‰ç¼“å­˜ã€‚"
    echo "æœ€åŽæŠ¥é”™æ—¥å¿—ï¼š"
    tail -n 5 /var/log/cloudflared.err
elif grep -q "Registered tunnel connection" /var/log/cloudflared.err /var/log/cloudflared.log; then
    echo "âœ…âœ…âœ… ç»ˆäºŽï¼ï¼ï¼Tunnel è¿žæŽ¥æˆåŠŸï¼"
    echo "çŽ°åœ¨ä½ çš„ IPv6 å°é¸¡å·²ç»é€šè¿‡ WireProxy ä»£ç†æˆåŠŸè¿žæŽ¥åˆ° Cloudflare äº†ã€‚"
else
    echo "â„¹ï¸ æ— æ ¼å¼é”™è¯¯ï¼ŒæŸ¥çœ‹è¿žæŽ¥æ—¥å¿—ï¼š"
    echo "--------------------------------"
    tail -n 10 /var/log/cloudflared.err
fi
