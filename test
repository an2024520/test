#!/bin/sh

echo "ðŸ›‘ ç¬¬ä¸€æ­¥ï¼šåœæ­¢æ—§æœåŠ¡..."
rc-service cloudflared stop
killall cloudflared 2>/dev/null

echo "ðŸ“ ç¬¬äºŒæ­¥ï¼šè¯·è¾“å…¥ Token..."
echo "è¯·åŠ¡å¿…ç²˜è´´ä»¥ 'eyJh' å¼€å¤´çš„å®Œæ•´é•¿ä¸²ï¼š"
read -r MY_TOKEN

# ç®€å•æ£€æŸ¥ Token æ ¼å¼
if echo "$MY_TOKEN" | grep -q "^eyJh"; then
    echo "âœ… Token æ ¼å¼çœ‹èµ·æ¥æ­£ç¡®ã€‚"
else
    echo "âš ï¸ è­¦å‘Šï¼šä½ è¾“å…¥çš„ Token å¯èƒ½ä¸æ­£ç¡® (ä¸æ˜¯ä»¥ eyJh å¼€å¤´)ã€‚"
    echo "ä½†æˆ‘ä»¬å°†ç»§ç»­å°è¯•..."
fi

echo "âš™ï¸ ç¬¬ä¸‰æ­¥ï¼šå†™å…¥ä¿®æ­£åŽçš„é…ç½®æ–‡ä»¶..."
mkdir -p /etc/cloudflared
# æ ¸å¿ƒä¿®æ­£ï¼š
# 1. edge-ip-version åŠ ä¸Šäº†åŒå¼•å· "6"
# 2. protocol ä¿æŒ http2
cat > /etc/cloudflared/config.yml <<EOF
tunnel: $MY_TOKEN
edge-ip-version: "6"
protocol: http2
logfile: /var/log/cloudflared.log
loglevel: info
EOF

echo "ðŸš€ ç¬¬å››æ­¥ï¼šé‡ç½®æœåŠ¡å¹¶å¯åŠ¨..."
# é‡å†™å¯åŠ¨è„šæœ¬ï¼Œä¸å¸¦ä»»ä½•å‚æ•°ï¼Œè®©å®ƒå¼ºåˆ¶è¯» config.yml
cat > /etc/init.d/cloudflared <<EOF
#!/sbin/openrc-run

name="cloudflared"
description="Cloudflare Tunnel Agent"
command="/usr/bin/cloudflared"
command_args="tunnel run"
command_background=true
pidfile="/run/cloudflared.pid"
output_log="/var/log/cloudflared.log"
error_log="/var/log/cloudflared.err"

depend() {
    need net
    after firewall
}
EOF
chmod +x /etc/init.d/cloudflared

# å¯åŠ¨
rc-service cloudflared restart
sleep 5

echo "ðŸ“Š æœ€ç»ˆæ£€æŸ¥..."
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é‚£ä¸ªç±»åž‹é”™è¯¯
if grep -q "expected string found int" /var/log/cloudflared.err; then
    echo "âŒ å¤±è´¥ï¼šä¾ç„¶æç¤ºé…ç½®æ ¼å¼é”™è¯¯ã€‚"
elif grep -q "Registered tunnel connection" /var/log/cloudflared.err /var/log/cloudflared.log; then
    echo "âœ…âœ…âœ… æˆåŠŸï¼Tunnel å·²æ³¨å†Œå¹¶è¿žæŽ¥ï¼"
else
    echo "â„¹ï¸ è¯·æŸ¥çœ‹ä¸‹æ–¹æœ€æ–°æ—¥å¿—åˆ¤æ–­çŠ¶æ€ï¼š"
    echo "--------------------------------"
    tail -n 10 /var/log/cloudflared.err
fi
