#!/bin/sh

echo "ðŸ§¨ å¯åŠ¨å½»åº•æ¸…ç†æ¨¡å¼..."

# 1. åœæ­¢å¹¶æŸ¥æ€æœåŠ¡
rc-service cloudflared stop >/dev/null 2>&1
killall cloudflared >/dev/null 2>&1

# 2. ã€å…³é”®ã€‘åˆ é™¤æ‰€æœ‰å¯èƒ½çš„é…ç½®æ–‡ä»¶è·¯å¾„
# è¿™å°±æ˜¯ä½ æŠ¥é”™ä¸€ç›´åœ¨é‡å¤çš„åŽŸå› ï¼å¿…é¡»åˆ å¹²å‡€ï¼
echo "ðŸ§¹ åˆ é™¤æ‰€æœ‰æ®‹ç•™é…ç½®..."
rm -rf /etc/cloudflared
rm -rf /root/.cloudflared
rm -f /etc/init.d/cloudflared
rm -f /usr/local/etc/cloudflared/config.yml
rm -f /usr/local/etc/cloudflared/config.yaml

# 3. æ£€æŸ¥ WireProxy æ˜¯å¦æ´»ç€
echo "ðŸ” æ£€æŸ¥ WireProxy çŠ¶æ€..."
if netstat -an | grep -q "127.0.0.1:40000"; then
    echo "âœ… æ£€æµ‹åˆ° WireProxy (ç«¯å£ 40000) æ­£åœ¨è¿è¡Œï¼"
else
    echo "âš ï¸ æœªæ£€æµ‹åˆ°ç«¯å£ 40000ï¼Œå°è¯•å¯åŠ¨ WireProxy..."
    rc-service wireproxy restart >/dev/null 2>&1
    sleep 3
    if netstat -an | grep -q "127.0.0.1:40000"; then
        echo "âœ… WireProxy å¯åŠ¨æˆåŠŸï¼"
    else
        echo "âŒ ä¸¥é‡é”™è¯¯ï¼šWireProxy æ— æ³•å¯åŠ¨ã€‚"
        echo "è¯·å…ˆç¡®ä¿ä½ è¿è¡Œè¿‡ä¹‹å‰çš„ WireProxy å®‰è£…è„šæœ¬ã€‚"
        exit 1
    fi
fi

# 4. å‡†å¤‡ Token (å·²è‡ªåŠ¨å¡«å…¥)
MY_TOKEN="eyJhIjoiYWYzN2NhNDc5NDRkMDFlNGY1NTQ2ZmU2NWIyMzRlNjQiLCJ0IjoiNWU5MDYwMjMtMzUxMC00MTZlLWI5MjUtMDQ5YmRmNDA1OWVkIiwicyI6Ik1qYzFPVE5oWlRrdE5HRTRNUzAwWkRjNUxXRmpNRGd0TlRGa1pqSmpZemRrTjJJeiJ9"

echo "âš™ï¸ å†™å…¥ä»£ç†æ¨¡å¼å¯åŠ¨è„šæœ¬..."
# æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ä»»ä½• --config å‚æ•°ï¼Œä¹Ÿæ²¡æœ‰ config.yml æ–‡ä»¶
# å½»åº•æœç»è¯»å–åˆ°é”™è¯¯é…ç½®çš„å¯èƒ½æ€§
cat > /etc/init.d/cloudflared <<INIT
#!/sbin/openrc-run

name="cloudflared"
description="Cloudflare Tunnel Agent"
command="/usr/bin/cloudflared"
command_args="tunnel run --token $MY_TOKEN"
command_background=true
pidfile="/run/cloudflared.pid"
output_log="/var/log/cloudflared.log"
error_log="/var/log/cloudflared.err"

depend() {
    need net
    after firewall
    need wireproxy
}

start_pre() {
    # æ ¸å¿ƒï¼šé€šè¿‡çŽ¯å¢ƒå˜é‡å¼ºåˆ¶èµ°æœ¬åœ°ä»£ç†
    # è¿™æ · Cloudflared ä»¥ä¸ºè‡ªå·±åœ¨è¿ž IPv4ï¼Œå®Œå…¨é¿å¼€ IPv6 è§£æž BUG
    export TUNNEL_PROXY_ADDRESS="127.0.0.1"
    export TUNNEL_PROXY_PORT="40000"
    # åŒæ—¶ä¹Ÿå¼ºåˆ¶ä¸€ä¸‹åè®®ï¼ŒåŒé‡ä¿é™©
    export TUNNEL_PROTOCOL="http2"
}
INIT
chmod +x /etc/init.d/cloudflared

echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
rc-service cloudflared restart
sleep 6

echo "ðŸ“Š æœ€ç»ˆæ£€æŸ¥..."
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é‚£ä¸ªæ ¼å¼é”™è¯¯
if grep -q "expected string found int" /var/log/cloudflared.err; then
    echo "âŒ è§é¬¼äº†ï¼šæ€Žä¹ˆè¿˜æœ‰æ ¼å¼é”™è¯¯ï¼Ÿ(è¯·æ‰‹åŠ¨æ£€æŸ¥ /home ç›®å½•)"
elif grep -q "Registered tunnel connection" /var/log/cloudflared.err /var/log/cloudflared.log; then
    echo "âœ…âœ…âœ… å®Œç¾Žè§£å†³ï¼Cloudflared å·²é€šè¿‡ WireProxy æˆåŠŸè¿žæŽ¥ï¼"
    echo "IPv6 Bug å·²è¢«å½»åº•ç»•è¿‡ã€‚"
else
    echo "â„¹ï¸ æŸ¥çœ‹æœ€æ–°æ—¥å¿—ï¼š"
    echo "--------------------------------"
    tail -n 10 /var/log/cloudflared.err
fi
